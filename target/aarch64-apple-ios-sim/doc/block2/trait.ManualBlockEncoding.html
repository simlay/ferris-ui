<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="Interim abstraction to manually provide block encodings for use at compile time with `StackBlock::with_encoding` and `RcBlock::with_encoding`."><title>ManualBlockEncoding in block2 - Rust</title><script>if(window.location.protocol!=="file:")document.head.insertAdjacentHTML("beforeend","SourceSerif4-Regular-6b053e98.ttf.woff2,FiraSans-Italic-81dc35de.woff2,FiraSans-Regular-0fe48ade.woff2,FiraSans-MediumItalic-ccf7e434.woff2,FiraSans-Medium-e1aa3f0a.woff2,SourceCodePro-Regular-8badfe75.ttf.woff2,SourceCodePro-Semibold-aa29a496.ttf.woff2".split(",").map(f=>`<link rel="preload" as="font" type="font/woff2"href="../static.files/${f}">`).join(""))</script><link rel="stylesheet" href="../static.files/normalize-9960930a.css"><link rel="stylesheet" href="../static.files/rustdoc-ca0dd0c4.css"><meta name="rustdoc-vars" data-root-path="../" data-static-root-path="../static.files/" data-current-crate="block2" data-themes="" data-resource-suffix="" data-rustdoc-version="1.92.0-nightly (b925a865e 2025-10-09)" data-channel="nightly" data-search-js="search-8d3311b9.js" data-stringdex-js="stringdex-828709d0.js" data-settings-js="settings-c38705f0.js" ><script src="../static.files/storage-e2aeef58.js"></script><script defer src="sidebar-items.js"></script><script defer src="../static.files/main-ce535bd0.js"></script><noscript><link rel="stylesheet" href="../static.files/noscript-263c88ec.css"></noscript><link rel="alternate icon" type="image/png" href="../static.files/favicon-32x32-eab170b8.png"><link rel="icon" type="image/svg+xml" href="../static.files/favicon-044be391.svg"></head><body class="rustdoc trait"><!--[if lte IE 11]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><rustdoc-topbar><h2><a href="#">ManualBlockEncoding</a></h2></rustdoc-topbar><nav class="sidebar"><div class="sidebar-crate"><h2><a href="../block2/index.html">block2</a><span class="version">0.6.2</span></h2></div><div class="sidebar-elems"><section id="rustdoc-toc"><h2 class="location"><a href="#">Manual<wbr>Block<wbr>Encoding</a></h2><h3><a href="#">Sections</a></h3><ul class="block top-toc"><li><a href="#safety" title="Safety">Safety</a></li><li><a href="#encoding-string-generation" title="Encoding string generation">Encoding string generation</a></li></ul><h3><a href="#required-associated-consts">Required Associated Constants</a></h3><ul class="block"><li><a href="#associatedconstant.ENCODING_CSTR" title="ENCODING_CSTR">ENCODING_CSTR</a></li></ul><h3><a href="#required-associated-types">Required Associated Types</a></h3><ul class="block"><li><a href="#associatedtype.Arguments" title="Arguments">Arguments</a></li><li><a href="#associatedtype.Return" title="Return">Return</a></li></ul><h3><a href="#dyn-compatibility">Dyn Compatibility</a></h3><h3><a href="#implementors">Implementors</a></h3></section><div id="rustdoc-modnav"><h2 class="in-crate"><a href="index.html">In crate block2</a></h2></div></div></nav><div class="sidebar-resizer" title="Drag to resize sidebar"></div><main><div class="width-limiter"><section id="main-content" class="content"><div class="main-heading"><div class="rustdoc-breadcrumbs"><a href="index.html">block2</a></div><h1>Trait <span class="trait">Manual<wbr>Block<wbr>Encoding</span>&nbsp;<button id="copy-path" title="Copy item path to clipboard">Copy item path</button></h1><rustdoc-toolbar></rustdoc-toolbar><span class="sub-heading"><a class="src" href="../src/block2/traits.rs.html#248-255">Source</a> </span></div><pre class="rust item-decl"><code>pub unsafe trait ManualBlockEncoding {
    type <a href="#associatedtype.Arguments" class="associatedtype">Arguments</a>: <a class="trait" href="../objc2/encode/trait.EncodeArguments.html" title="trait objc2::encode::EncodeArguments">EncodeArguments</a>;
    type <a href="#associatedtype.Return" class="associatedtype">Return</a>: <a class="trait" href="../objc2/encode/trait.EncodeReturn.html" title="trait objc2::encode::EncodeReturn">EncodeReturn</a>;

    const <a href="#associatedconstant.ENCODING_CSTR" class="constant">ENCODING_CSTR</a>: &amp;'static <a class="struct" href="https://doc.rust-lang.org/nightly/core/ffi/c_str/struct.CStr.html" title="struct core::ffi::c_str::CStr">CStr</a>;
}</code></pre><details class="toggle top-doc" open><summary class="hideme"><span>Expand description</span></summary><div class="docblock"><p>Interim abstraction to manually provide block encodings for use at compile
time with <a href="struct.StackBlock.html#method.with_encoding" title="associated function block2::StackBlock::with_encoding"><code>StackBlock::with_encoding</code></a> and <a href="struct.RcBlock.html#method.with_encoding" title="associated function block2::RcBlock::with_encoding"><code>RcBlock::with_encoding</code></a>.</p>
<p>See these functions for examples of how to implement and use this trait,
since its sole purpose is passing values at compile time to them.</p>
<p>As a side note, one might be surprised by the additional <a href="trait.ManualBlockEncoding.html#associatedtype.Arguments"><code>Self::Arguments</code></a>
and <a href="trait.ManualBlockEncoding.html#associatedtype.Return"><code>Self::Return</code></a> associated types requiring concrete implementations to
specify them while they are not actually used. This is intentional:</p>
<ul>
<li>the types are checked at compile-time to be equal to the ones used with
<a href="struct.RcBlock.html#method.with_encoding" title="associated function block2::RcBlock::with_encoding"><code>RcBlock::with_encoding</code></a> and <a href="struct.StackBlock.html#method.with_encoding" title="associated function block2::StackBlock::with_encoding"><code>StackBlock::with_encoding</code></a>, usually
inferred by the compiler when giving a closure: this should help avoid
some easy oversights;</li>
<li>the user is forced to write both the standard Rust types and the
encoding string at the same time, so particular attention to the types
is put to the forefront for them;</li>
<li>reading a block encoding string is tough when not initiated, so these
also serve as self-documentation;</li>
<li>the safety validation can be moved to the trait implementation, so that
the use can be marked safe.</li>
</ul>
<h2 id="safety"><a class="doc-anchor" href="#safety">§</a>Safety</h2>
<p><a href="trait.ManualBlockEncoding.html#associatedconstant.ENCODING_CSTR"><code>Self::ENCODING_CSTR</code></a> must correspond to the actual signature string a
recent-enough Objective-C compiler would generate for a block taking in
<a href="trait.ManualBlockEncoding.html#associatedtype.Arguments"><code>Self::Arguments</code></a> as input and returning <a href="trait.ManualBlockEncoding.html#associatedtype.Return"><code>Self::Return</code></a> as output.
This information is actually used by the Objective-C runtime in order to
correctly invoke the block, so specifying a wrong encoding is definitely a
soundness issue: see <a href="https://github.com/madsmtm/objc2/issues/442#issuecomment-2284932726">this issue comment</a> for more details
about what exactly goes on behind the scenes in order to justify all the
following precautions.</p>
<p>The easiest way to do this is probably to ask Clang; the following program
will print the signature of the block (if you’re having trouble linking,
you should be able to find the signature in the assembly output).</p>
<div class="example-wrap"><pre class="language-objective-c"><code>#import &lt;Foundation/Foundation.h&gt;

// Unstable API, but fine for test usage like this.
const char * _Block_signature(void *);

int main() {
    // Declare the signature of your block.
    // This one takes `id` and `int`, and returns `NSString*`.
    id block = ^NSString* (id a, int b) {
        return nil;
    };

    printf(&quot;%s\n&quot;, _Block_signature((void*)block));
    return 0;
}</code></pre></div>
<p>A more thorough but manual approach is to only follow the rules described
below.</p>
<p>In this process, you may be able to use <a href="../objc2_encode/encoding/enum.Encoding.html#impl-Display-for-Encoding" title="enum objc2_encode::encoding::Encoding"><code>Encoding::to_string</code></a> in
order to get the various components of the signature string and then
concatenate them manually with the required numbers (described below)
inserted at their correct place.</p>
<h2 id="encoding-string-generation"><a class="doc-anchor" href="#encoding-string-generation">§</a>Encoding string generation</h2>
<p>This is the result of the <code>@encode</code> Objective-C compiler directive. The
<a href="https://developer.apple.com/library/archive/documentation/Cocoa/Conceptual/ObjCRuntimeGuide/Articles/ocrtTypeEncodings.html">Apple documentation</a> and <a href="https://gcc.gnu.org/onlinedocs/gcc/Type-encoding.html">GCC documentation</a> explain how each base type is
encoded into a string representation. See there for a somewhat-formal
specification and a few basic examples. See also <a href="../objc2_encode/encoding/enum.Encoding.html" title="enum objc2_encode::encoding::Encoding"><code>Encoding</code></a>.</p>
<p>See also the <a href="https://gcc.gnu.org/onlinedocs/gcc/Method-signatures.html">GCC method signatures</a> section. It is mostly valid for blocks
as well, since they are basically functions with captured environment –
i.e. closures, except that no selector is implicitly sent, only the block
object is. In short, the “signature” is a null-terminated string, composed
of the following, in order:</p>
<ul>
<li>The return type, including type qualifiers. For example, a block
returning <code>int</code> (<a href="https://doc.rust-lang.org/nightly/std/primitive.i32.html" title="primitive i32"><code>i32</code></a>) would have <code>i</code> here.</li>
<li>The total size (in bytes) required to pass all the parameters: the call
frame size. This includes the hidden block object parameter that is
passed as a pointer, so at least 4 bytes when under a 32-bit system or
most probably 8 bytes when under a 64-bit one.</li>
<li>Each argument, with the type encoding, followed by the offset (in bytes)
of the argument in the list of parameters. The first is the always the
hidden block object pointer and is therefore <code>@?0</code>.</li>
</ul>
<p>Examples:</p>
<div><table><thead><tr><th>Objective-C signature</th><th>Runtime encoding</th></tr></thead><tbody>
<tr><td><code>void (^)(void)</code></td><td><code>v8@?0</code></td></tr>
<tr><td><code>int (^)(void)</code></td><td><code>i8@?0</code></td></tr>
<tr><td><code>int (^)(float)</code></td><td><code>i12@?0f8</code></td></tr>
<tr><td><code>int (^)(float, _Bool)</code></td><td><code>i16@?0f8B12</code></td></tr>
<tr><td><code>void (^)(int*)</code></td><td><code>v16@?0^i8</code></td></tr>
<tr><td><code>void (^)(NSError*)</code></td><td><code>v16@?0@8</code> or <code>v16@?0@"NSError"8</code></td></tr>
<tr><td><code>NSError* (^)(NSError*)</code></td><td><code>@16@?0@8</code> or <code>@"NSError"16@?0@"NSError"8</code></td></tr>
</tbody></table>
</div></div></details><h2 id="required-associated-consts" class="section-header">Required Associated Constants<a href="#required-associated-consts" class="anchor">§</a></h2><div class="methods"><details class="toggle" open><summary><section id="associatedconstant.ENCODING_CSTR" class="method"><a class="src rightside" href="../src/block2/traits.rs.html#254">Source</a><h4 class="code-header">const <a href="#associatedconstant.ENCODING_CSTR" class="constant">ENCODING_CSTR</a>: &amp;'static <a class="struct" href="https://doc.rust-lang.org/nightly/core/ffi/c_str/struct.CStr.html" title="struct core::ffi::c_str::CStr">CStr</a></h4></section></summary><div class="docblock"><p>The raw encoding information string.</p>
</div></details></div><h2 id="required-associated-types" class="section-header">Required Associated Types<a href="#required-associated-types" class="anchor">§</a></h2><div class="methods"><details class="toggle" open><summary><section id="associatedtype.Arguments" class="method"><a class="src rightside" href="../src/block2/traits.rs.html#250">Source</a><h4 class="code-header">type <a href="#associatedtype.Arguments" class="associatedtype">Arguments</a>: <a class="trait" href="../objc2/encode/trait.EncodeArguments.html" title="trait objc2::encode::EncodeArguments">EncodeArguments</a></h4></section></summary><div class="docblock"><p>The function’s input argument types.</p>
</div></details><details class="toggle" open><summary><section id="associatedtype.Return" class="method"><a class="src rightside" href="../src/block2/traits.rs.html#252">Source</a><h4 class="code-header">type <a href="#associatedtype.Return" class="associatedtype">Return</a>: <a class="trait" href="../objc2/encode/trait.EncodeReturn.html" title="trait objc2::encode::EncodeReturn">EncodeReturn</a></h4></section></summary><div class="docblock"><p>The function’s return type.</p>
</div></details></div><h2 id="dyn-compatibility" class="section-header">Dyn Compatibility<a href="#dyn-compatibility" class="anchor">§</a></h2><div class="dyn-compatibility-info"><p>This trait is <b>not</b> <a href="https://doc.rust-lang.org/nightly/reference/items/traits.html#dyn-compatibility">dyn compatible</a>.</p><p><i>In older versions of Rust, dyn compatibility was called "object safety", so this trait is not object safe.</i></p></div><h2 id="implementors" class="section-header">Implementors<a href="#implementors" class="anchor">§</a></h2><div id="implementors-list"></div><script src="../trait.impl/block2/traits/trait.ManualBlockEncoding.js" async></script></section></div></main></body></html>